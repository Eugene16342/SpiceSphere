<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>異食鍋|登入頁</title>
    <link rel="stylesheet" href="/login.css" />
    <link rel="icon" href="../../img/common/favicon.ico" />
    <script src="/Backstage/jquery/jquery-3.7.1.min.js"></script>
</head>
<script>
$(document).ready(function() {
    function togglePasswordVisibility() {
        let passwordField = $(this).prev('input[type="password"], input[type="text"]');
        let passwordFieldType = passwordField.attr('type');
        let eyeIcon = $(this).find('svg');
        
        if (passwordFieldType === 'password') {
            passwordField.attr('type', 'text');
            eyeIcon.css('fill', 'var(--main_orange)');
        } else {
            passwordField.attr('type', 'password');
            eyeIcon.css('fill', 'var(--border_gray)');
        }
    }

    // Use event delegation for dynamically created elements
    $(document).on('click', '.eye', togglePasswordVisibility);

    $('#register').on('click', function() {
        $('#login_bg').html(`
            <div class="text">歡迎註冊！請填寫以下資訊。</div>
            <div class="login_section">
                <div class="title">註冊</div>
                <input class="register_input" id="user_name"  maxlength="20" placeholder="請輸入姓名">
                <input class="register_input" type="email" id="email" placeholder="請輸入電子信箱">
                <input class="register_input" id="new_account"  maxlength="20" placeholder="請輸入帳號">
                <input class="register_input" type="password" id="new_password"  maxlength="20" placeholder="請輸入新密碼">
                <div class="eye">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
                    </svg>
                </div>
                <input class="register_input" type="password" id="confirm_password"  maxlength="20" placeholder="請確認新密碼">
                <div class="eye">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
                    </svg>
                </div>
                <button id="submit_register">提交</button>
                <a class="back" href="/login">回到登入</a>
            </div>
        `);
    });

    $(document).on('click', '#submit_register', function() {
    const userName = $('#user_name').val();
    const email = $('#email').val();
    const account = $('#new_account').val();
    const password = $('#new_password').val();
    const confirmPassword = $('#confirm_password').val();

    if (password !== confirmPassword) {
        alert('密碼不一致，請重新確認');
        return;
    }

    console.log({ userName, email, account, password });

    fetch('http://localhost:3000/api/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userName, email, account, password })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.message === '註冊成功') {
            window.location.href = '/login';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('註冊失敗，請稍後再試');
    });
});

$('#login').on('click', function() {
    const account = $('#account').val();
    const password = $('#password').val();

    fetch('http://localhost:3000/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'include', // 攜帶 cookie
        body: JSON.stringify({ account, password })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.message === '登入成功') {
            sessionStorage.setItem('username', data.username); // 儲存使用者名稱
            window.location.href = '/home_page'; // 登入成功後重新加載主頁
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('登入失敗，請稍後再試');
    });
});
    
    $('#forget').on('click',function(){
    $('.login_section').html(`
<div class="title">忘記密碼</div>
                <input  id="new_account"  maxlength="20" placeholder="請輸入帳號">
                <input  type="email" placeholder="請輸入電子信箱">
                <div>提交後，我們會將密碼寄至您的電子信箱</div>
                <button id="submit_forget">提交</button>
                <a class="back" href="/login">回到登入</a>
            </div>
    `)
})
});



</script>
<body>

    <div id="login_bg">
        <div class="text">Lorem ipsum dolor, sit amet consectetur adipisicing elit. Tenetur error id, autem numquam quasi accusantium iure eos ab voluptatum! Natus at error ipsam ea vel pariatur dolor expedita adipisci ut.</div>
        <div class="login_section">
            <div class="title">登入</div>
           <input id="account" maxlength="20" placeholder="請輸入帳號">
           <input type="password" id="password" maxlength="20" placeholder="請輸入密碼">
          <div class="eye">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
              </svg>
          </div> 
           <div id="forget" class="small ">忘記密碼嗎?</div>
           
            <button id="login">登入</button> 
            <div class="small">新朋友嗎?</div>
            <button id="register">註冊</button>
           </div>
        </div>
    </div>



    <%- include('footer') %>
    
</body>
</html>